<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <title>Viewer - Watch game-host</title>
  <style>
    body {
      margin: 0;
      background: #111;
      color: #eee;
      font-family: Arial, sans-serif;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    #controls {
      padding: 8px;
      background: #222;
      border-bottom: 1px solid #333;
      display: flex;
      gap: 8px;
      align-items: center;
    }

    button {
      padding: 6px 12px;
      background: #3a7bfd;
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }

    button:disabled {
      opacity: 0.5;
      cursor: default;
    }

    button:hover:not(:disabled) {
      background: #2d6be0;
    }

    #spawnBtn {
      background: #e74c3c;
    }

    #spawnBtn:hover:not(:disabled) {
      background: #c0392b;
    }

    #video-container {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #000;
    }

    video {
      max-width: 100%;
      max-height: 100%;
      background: #000;
    }

    #log {
      height: 120px;
      overflow-y: auto;
      font-size: 12px;
      background: #222;
      padding: 8px;
      box-sizing: border-box;
    }
  </style>
</head>

<body>
  <div id="controls">
    <button id="startBtn" disabled>Start watching</button>
    <button id="spawnBtn" disabled>Spawn Monster</button>
  </div>
  <div id="video-container">
    <video id="remoteVideo" autoplay playsinline></video>
  </div>
  <pre id="log"></pre>

  <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
  <script>
    const video = document.getElementById('remoteVideo');
    const logEl = document.getElementById('log');
    const startBtn = document.getElementById('startBtn');
    const spawnBtn = document.getElementById('spawnBtn');

    let pendingStream = null;
    let dataConnection = null;

    function log(msg) {
      console.log(msg);
      logEl.textContent += msg + '\n';
      logEl.scrollTop = logEl.scrollHeight;
    }

    // Viewer connects to the same PeerJS server and:
    // 1) opens a data connection to "game-host" so the host knows this viewer exists
    // 2) waits for the host to start a media call and answers it
    const peer = new Peer(null, {
      host: 'localhost',
      port: 9000,
      path: '/myapp',
      secure: false
    });

    peer.on('open', id => {
      log('Viewer Peer ID: ' + id);

      log('Opening data connection to game-host...');
      dataConnection = peer.connect('game-host');

      dataConnection.on('open', () => {
        log('Data connection to game-host opened');
        spawnBtn.disabled = false;
        // Send a small message so host knows this viewer is ready
        dataConnection.send({ type: 'viewer-hello', viewerId: id });
      });

      dataConnection.on('error', err => {
        log('Data connection error: ' + err);
      });

      dataConnection.on('close', () => {
        log('Data connection closed');
        spawnBtn.disabled = true;
      });

      dataConnection.on('data', data => {
        log('Received data from host: ' + JSON.stringify(data));
      });
    });

    // Host will initiate the media call; viewer just answers and shows the stream
    peer.on('call', call => {
      log('Incoming media call from ' + call.peer + ', answering...');
      call.answer(null); // no local media to send back

      call.on('stream', remoteStream => {
        log('Received remote stream from game-host');
        pendingStream = remoteStream;
        video.srcObject = remoteStream;
        startBtn.disabled = false;
      });

      call.on('error', err => {
        log('Call error: ' + err);
      });

      call.on('close', () => {
        log('Call closed');
      });
    });

    // User gesture to actually start playback (avoids autoplay restrictions)
    startBtn.addEventListener('click', () => {
      if (!pendingStream) {
        log('No stream received yet from host.');
        return;
      }
      startBtn.disabled = true;
      video.muted = true; // helps some browsers allow autoplay
      video.play().catch(err => {
        log('Video play error: ' + err);
        startBtn.disabled = false;
      });
    });

    // Spawn monster button
    spawnBtn.addEventListener('click', () => {
      if (!dataConnection || !dataConnection.open) {
        log('Data connection not open. Cannot spawn monster.');
        return;
      }

      // Send spawn command to Unity game
      // x and y are null (random), but you can set them if you want specific positions
      const spawnCommand = {
        type: 'spawn-monster',
        viewerId: peer.id,
        x: null,  // null = random position
        y: null   // null = random position
      };

      dataConnection.send(spawnCommand);
      log('Sent spawn monster command to game-host');
    });

    peer.on('error', err => {
      log('Peer error: ' + err);
    });
  </script>
</body>

</html>